name: Install, test and release the library

on:
  push:
    branches:
      - "master"
  pull_request:
    branches:
      - "*"

jobs:
  build-install-and-test:
    name: Build, install and test the library
    runs-on: "ubuntu-latest"
    steps:
      - name: Checkout the code
        uses: actions/checkout@v2

      - name: Cache conda
        uses: actions/cache@v2
        env:
          CACHE_NUMBER: 1
        with:
          path: ~/conda_pkgs_dir
          key: conda-${{ runner.os }}-${{ env.CACHE_NUMBER }}-${{ hashFiles('environment.yml') }}

      - name: Setup conda
        uses: goanpeca/setup-miniconda@v1
        with:
          channels: conda-forge
          activate-environment: app-env
          mamba-version: "*"
          use-only-tar-bz2: true # requried for caching
          # environment-file: environment.yml

      - name: List dependencies
        shell: bash -l {0}
        run: |
          mamba env update -f environment.yml
          mamba list

      - name: Install library
        shell: bash -l {0}
        run: |
          mamba env list
          python -m pip install .

      - name: Run tests
        shell: bash -l {0}
        run: |
          pytest .
